#!/bin/bash
# ============================================================================
# SEED Pre-Push Hook
# å¢é‡æ£€æŸ¥ï¼šæ£€æŸ¥æ‰€æœ‰æœªæ¨é€çš„ commits
# ============================================================================

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ£€æŸ¥æ˜¯å¦åœ¨ SEED é¡¹ç›®ä¸­
if [ ! -f ".seed/config.json" ]; then
    exit 0
fi

# è¯»å–æ¨é€å‚æ•°
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # åˆ é™¤åˆ†æ”¯ï¼Œè·³è¿‡
        continue
    fi

    echo -e "${BLUE}ğŸ” SEED å¢é‡æ£€æŸ¥...${NC}"

    # è·å–æœªæ¨é€çš„ commits æ¶‰åŠçš„æ–‡ä»¶
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # æ–°åˆ†æ”¯ï¼Œæ£€æŸ¥ä¸ main çš„å·®å¼‚
        UNPUSHED_FILES=$(git diff --name-only origin/main...HEAD 2>/dev/null || git diff --name-only HEAD~10...HEAD 2>/dev/null || echo "")
    else
        UNPUSHED_FILES=$(git diff --name-only "$remote_sha"..."$local_sha" 2>/dev/null || echo "")
    fi

    if [ -z "$UNPUSHED_FILES" ]; then
        echo -e "${GREEN}âœ… æ— æ–‡ä»¶å˜æ›´${NC}"
        continue
    fi

    # è¿‡æ»¤è§„æ ¼ç›¸å…³æ–‡ä»¶
    SPEC_FILES=$(echo "$UNPUSHED_FILES" | grep -E '\.(fspec\.md|js|ts)$' || echo "")

    if [ -z "$SPEC_FILES" ]; then
        echo -e "${GREEN}âœ… æ— è§„æ ¼ç›¸å…³æ–‡ä»¶å˜æ›´${NC}"
        continue
    fi

    echo -e "${YELLOW}æ£€æŸ¥æ–‡ä»¶: $(echo "$SPEC_FILES" | wc -l | tr -d ' ') ä¸ª${NC}"

    # å¢é‡æ£€æŸ¥ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
    if [ -f ".seed/scripts/incremental-defend.js" ]; then
        if ! node .seed/scripts/incremental-defend.js --files="$SPEC_FILES"; then
            echo -e "${RED}âŒ SEED æ£€æŸ¥å¤±è´¥ï¼Œæ¨é€è¢«é˜»æ­¢${NC}"
            echo -e "${YELLOW}è¯·ä¿®å¤é—®é¢˜åé‡æ–°æ¨é€${NC}"
            exit 1
        fi
    fi

    # æ›´æ–°ç¼“å­˜
    if [ -f ".seed/scripts/update-cache.js" ]; then
        node .seed/scripts/update-cache.js --files="$SPEC_FILES" 2>/dev/null || true
    fi

    echo -e "${GREEN}âœ… SEED å¢é‡æ£€æŸ¥é€šè¿‡${NC}"
done

exit 0
