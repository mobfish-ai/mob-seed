#!/bin/bash
# ============================================================================
# SEED Pre-Commit Hook
# 快速检查：仅检查 staged 文件
# ============================================================================

set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 跳过检查（紧急情况）
if [ "$SKIP_SEED_CHECK" = "1" ]; then
    echo -e "${YELLOW}⚠️  SEED 检查已跳过${NC}"
    exit 0
fi

# 检查是否在 SEED 项目中
if [ ! -f ".seed/config.json" ]; then
    # 不是 SEED 项目，静默退出
    exit 0
fi

# 获取 staged 文件
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || echo "")

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# 过滤规格相关文件
SPEC_FILES=$(echo "$STAGED_FILES" | grep -E '\.(fspec\.md|js|ts)$' || echo "")

if [ -z "$SPEC_FILES" ]; then
    exit 0
fi

echo -e "${GREEN}🔍 SEED 快速检查...${NC}"

# 三层回退模式查找脚本
find_hook_script() {
    local script_name="$1"
    # Layer 1: 库路径（mob-seed 项目内）
    if [ -f "skills/mob-seed/lib/hooks/${script_name}.js" ]; then
        echo "skills/mob-seed/lib/hooks/${script_name}.js"
        return 0
    fi
    # Layer 2: 旧路径（向后兼容）
    if [ -f ".seed/scripts/${script_name}.js" ]; then
        echo ".seed/scripts/${script_name}.js"
        return 0
    fi
    return 1
}

# 检查缓存
CACHE_CHECKER=$(find_hook_script "cache-checker" || find_hook_script "check-cache" || echo "")
if [ -n "$CACHE_CHECKER" ]; then
    if node "$CACHE_CHECKER" --files="$SPEC_FILES" 2>/dev/null; then
        echo -e "${GREEN}✅ 使用缓存结果（文件未变更）${NC}"
        exit 0
    fi
fi

# 快速同步检查
QUICK_DEFENDER=$(find_hook_script "quick-defender" || find_hook_script "quick-defend" || echo "")
if [ -n "$QUICK_DEFENDER" ]; then
    if ! node "$QUICK_DEFENDER" --files="$SPEC_FILES"; then
        echo -e "${RED}❌ SEED 检查失败${NC}"
        echo -e "${YELLOW}提示: 使用 SKIP_SEED_CHECK=1 git commit 跳过（不推荐）${NC}"
        exit 1
    fi
fi

echo -e "${GREEN}✅ SEED 快速检查通过${NC}"
exit 0
