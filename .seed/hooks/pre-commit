#!/bin/bash
# ============================================================================
# SEED Pre-Commit Hook
# å¿«é€Ÿæ£€æŸ¥ï¼šä»…æ£€æŸ¥ staged æ–‡ä»¶
# ============================================================================

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# è·³è¿‡æ£€æŸ¥ï¼ˆç´§æ€¥æƒ…å†µï¼‰
if [ "$SKIP_SEED_CHECK" = "1" ]; then
    echo -e "${YELLOW}âš ï¸  SEED æ£€æŸ¥å·²è·³è¿‡${NC}"
    exit 0
fi

# æ£€æŸ¥æ˜¯å¦åœ¨ SEED é¡¹ç›®ä¸­
if [ ! -f ".seed/config.json" ]; then
    # ä¸æ˜¯ SEED é¡¹ç›®ï¼Œé™é»˜é€€å‡º
    exit 0
fi

# è·å– staged æ–‡ä»¶
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || echo "")

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# è¿‡æ»¤è§„æ ¼ç›¸å…³æ–‡ä»¶
SPEC_FILES=$(echo "$STAGED_FILES" | grep -E '\.(fspec\.md|js|ts)$' || echo "")

if [ -z "$SPEC_FILES" ]; then
    exit 0
fi

echo -e "${GREEN}ğŸ” SEED å¿«é€Ÿæ£€æŸ¥...${NC}"

# æ£€æŸ¥ç¼“å­˜è„šæœ¬æ˜¯å¦å­˜åœ¨
if [ -f ".seed/scripts/check-cache.js" ]; then
    # æ£€æŸ¥ç¼“å­˜
    if node .seed/scripts/check-cache.js --files="$SPEC_FILES" 2>/dev/null; then
        echo -e "${GREEN}âœ… ä½¿ç”¨ç¼“å­˜ç»“æœï¼ˆæ–‡ä»¶æœªå˜æ›´ï¼‰${NC}"
        exit 0
    fi
fi

# å¿«é€ŸåŒæ­¥æ£€æŸ¥
if [ -f ".seed/scripts/quick-defend.js" ]; then
    if ! node .seed/scripts/quick-defend.js --files="$SPEC_FILES"; then
        echo -e "${RED}âŒ SEED æ£€æŸ¥å¤±è´¥${NC}"
        echo -e "${YELLOW}æç¤º: ä½¿ç”¨ SKIP_SEED_CHECK=1 git commit è·³è¿‡ï¼ˆä¸æ¨èï¼‰${NC}"
        exit 1
    fi
fi

echo -e "${GREEN}âœ… SEED å¿«é€Ÿæ£€æŸ¥é€šè¿‡${NC}"
exit 0
