# æ¼‚ç§»æ£€æµ‹æŒ‡å¯¼

> SEED Dé˜¶æ®µ - æ£€æµ‹ä»£ç ä¸è§„æ ¼çš„åç¦»

## æ ¸å¿ƒæ¦‚å¿µ

**æ¼‚ç§» (Drift)**: ä»£ç å®ç°ä¸è§„æ ¼å®šä¹‰ä¹‹é—´çš„åå·®

### æ¼‚ç§»ç±»å‹

| ç±»å‹ | è¯´æ˜ | ä¸¥é‡ç¨‹åº¦ |
|------|------|----------|
| **ç¼ºå¤±æ¼‚ç§»** | è§„æ ¼å®šä¹‰ä½†ä»£ç æœªå®ç° | ä¸¥é‡ |
| **æ–°å¢æ¼‚ç§»** | ä»£ç å­˜åœ¨ä½†è§„æ ¼æœªå®šä¹‰ | ä¸­ç­‰ |
| **å˜å¼‚æ¼‚ç§»** | å®ç°ä¸è§„æ ¼æè¿°ä¸ç¬¦ | ä¸¥é‡ |
| **ç‰ˆæœ¬æ¼‚ç§»** | ç‰ˆæœ¬å·ä¸ä¸€è‡´ | è½»å¾® |

## æ£€æµ‹æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ¼‚ç§»æ£€æµ‹æµç¨‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. æ„å»ºè§„æ ¼æ¨¡å‹                                             â”‚
â”‚     â”œâ”€â”€ æå–æ‰€æœ‰éœ€æ±‚ ID (FR-xxx)                            â”‚
â”‚     â”œâ”€â”€ æå–æ‰€æœ‰éªŒæ”¶æ ‡å‡† ID (AC-xxx)                        â”‚
â”‚     â””â”€â”€ æ„å»ºéœ€æ±‚-éªŒæ”¶æ˜ å°„                                   â”‚
â”‚                                                              â”‚
â”‚  2. æ„å»ºä»£ç æ¨¡å‹                                             â”‚
â”‚     â”œâ”€â”€ æ‰«ææ‰€æœ‰ @see å¼•ç”¨                                  â”‚
â”‚     â”œâ”€â”€ æå–æ‰€æœ‰å¯¼å‡ºå‡½æ•°/ç±»                                 â”‚
â”‚     â””â”€â”€ åˆ†æå‡½æ•°å®ç°çŠ¶æ€                                    â”‚
â”‚                                                              â”‚
â”‚  3. å·®å¼‚æ¯”å¯¹                                                 â”‚
â”‚     â”œâ”€â”€ è§„æ ¼æœ‰ä½†ä»£ç æ—  â†’ ç¼ºå¤±æ¼‚ç§»                           â”‚
â”‚     â”œâ”€â”€ ä»£ç æœ‰ä½†è§„æ ¼æ—  â†’ æ–°å¢æ¼‚ç§»                           â”‚
â”‚     â””â”€â”€ ä¸¤è€…éƒ½æœ‰ä½†å†…å®¹ä¸ç¬¦ â†’ å˜å¼‚æ¼‚ç§»                       â”‚
â”‚                                                              â”‚
â”‚  4. ç”Ÿæˆæ¼‚ç§»æŠ¥å‘Š                                             â”‚
â”‚     â”œâ”€â”€ æŒ‰ä¸¥é‡ç¨‹åº¦æ’åº                                      â”‚
â”‚     â”œâ”€â”€ æä¾›å®šä½ä¿¡æ¯                                        â”‚
â”‚     â””â”€â”€ ç»™å‡ºä¿®å¤å»ºè®®                                        â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ£€æµ‹è§„åˆ™

### ç¼ºå¤±æ¼‚ç§»æ£€æµ‹

```javascript
// è§„åˆ™: è§„æ ¼ä¸­çš„ FR å¿…é¡»åœ¨ä»£ç ä¸­æœ‰ @see å¼•ç”¨

// è¾“å…¥:
// - è§„æ ¼ä¸­çš„ FR åˆ—è¡¨: [FR-001, FR-002, FR-003]
// - ä»£ç ä¸­çš„ @see å¼•ç”¨: [FR-001, FR-002]

// æ£€æµ‹é€»è¾‘:
const missingFRs = specFRs.filter(fr => !codeSeeRefs.includes(fr));
// ç»“æœ: [FR-003]

// æŠ¥å‘Š:
{
  type: 'MISSING_DRIFT',
  target: 'FR-003',
  severity: 'error',
  message: 'FR-003 åœ¨è§„æ ¼ä¸­å®šä¹‰ä½†ä»£ç æœªå®ç°',
  suggestion: 'åœ¨ä»£ç ä¸­æ·»åŠ  FR-003 å¯¹åº”çš„å‡½æ•°å®ç°'
}
```

### æ–°å¢æ¼‚ç§»æ£€æµ‹

```javascript
// è§„åˆ™: ä»£ç ä¸­å¯¼å‡ºçš„å‡½æ•°åº”è¯¥æœ‰å¯¹åº”çš„è§„æ ¼å®šä¹‰

// è¾“å…¥:
// - ä»£ç å¯¼å‡ºå‡½æ•°: [login, logout, resetPassword, changeEmail]
// - è§„æ ¼å®šä¹‰åŠŸèƒ½: [login, logout, resetPassword]

// æ£€æµ‹é€»è¾‘:
const undefinedFuncs = codeFuncs.filter(fn => !specDefinedFuncs.includes(fn));
// ç»“æœ: [changeEmail]

// æŠ¥å‘Š:
{
  type: 'ADDITION_DRIFT',
  target: 'changeEmail',
  severity: 'warning',
  message: 'changeEmail å‡½æ•°åœ¨ä»£ç ä¸­å­˜åœ¨ä½†è§„æ ¼æœªå®šä¹‰',
  suggestion: 'è¦ä¹ˆåœ¨è§„æ ¼ä¸­æ·»åŠ å¯¹åº”éœ€æ±‚ï¼Œè¦ä¹ˆåˆ é™¤è¯¥å‡½æ•°'
}
```

### å˜å¼‚æ¼‚ç§»æ£€æµ‹

```javascript
// è§„åˆ™: å®ç°åº”è¯¥ä¸è§„æ ¼æè¿°ä¸€è‡´

// ç¤ºä¾‹:
// è§„æ ¼: FR-001 ç”¨æˆ·å¯ä»¥ä½¿ç”¨é‚®ç®±å’Œå¯†ç ç™»å½•
// ä»£ç : login(username, password) - ä½¿ç”¨ username è€Œé email

// æ£€æµ‹æ–¹å¼:
// 1. åˆ†æå‡½æ•°ç­¾å
// 2. ä¸è§„æ ¼æè¿°å¯¹æ¯”
// 3. å‘ç°ä¸ä¸€è‡´

// æŠ¥å‘Š:
{
  type: 'MUTATION_DRIFT',
  target: 'FR-001',
  severity: 'error',
  message: 'å®ç°ä¸è§„æ ¼ä¸ç¬¦: è§„æ ¼è¦æ±‚ä½¿ç”¨é‚®ç®±ç™»å½•ï¼Œä½†ä»£ç ä½¿ç”¨ç”¨æˆ·å',
  specDescription: 'ç”¨æˆ·å¯ä»¥ä½¿ç”¨é‚®ç®±å’Œå¯†ç ç™»å½•',
  codeSignature: 'login(username, password)',
  suggestion: 'ä¿®æ”¹å‚æ•°åä¸º email æˆ–æ›´æ–°è§„æ ¼æè¿°'
}
```

### ç‰ˆæœ¬æ¼‚ç§»æ£€æµ‹

```javascript
// è§„åˆ™: æ´¾ç”Ÿäº§ç‰©ç‰ˆæœ¬åº”ä¸è§„æ ¼ç‰ˆæœ¬ä¸€è‡´

// è¾“å…¥:
// - è§„æ ¼ç‰ˆæœ¬: 2.0.0
// - ä»£ç æ³¨é‡Šç‰ˆæœ¬: @seed-version 1.0.0

// æ£€æµ‹:
if (specVersion !== codeVersion) {
  // ç‰ˆæœ¬æ¼‚ç§»
}

// æŠ¥å‘Š:
{
  type: 'VERSION_DRIFT',
  target: 'version',
  severity: 'info',
  message: 'ç‰ˆæœ¬ä¸ä¸€è‡´: è§„æ ¼ 2.0.0, ä»£ç  1.0.0',
  suggestion: 'é‡æ–°æ‰§è¡Œ emit æ›´æ–°æ´¾ç”Ÿäº§ç‰©'
}
```

## æ¼‚ç§»æŠ¥å‘Šæ ¼å¼

### è¯¦ç»†æŠ¥å‘Š (JSON)

```json
{
  "spec": "user-auth",
  "analyzedAt": "2024-12-28T10:35:00+08:00",
  "drifts": [
    {
      "type": "MISSING_DRIFT",
      "target": "FR-003",
      "severity": "error",
      "location": {
        "spec": "specs/user-auth.fspec.md:25"
      },
      "message": "FR-003 æœªå®ç°",
      "suggestion": "æ·»åŠ  FR-003 å¯¹åº”çš„å®ç°"
    }
  ],
  "summary": {
    "total": 5,
    "errors": 2,
    "warnings": 2,
    "info": 1
  }
}
```

### å¯è¯»æŠ¥å‘Š (Markdown)

```markdown
# æ¼‚ç§»æ£€æµ‹æŠ¥å‘Š: user-auth

## æ£€æµ‹ç»“æœ

| ä¸¥é‡ç¨‹åº¦ | æ•°é‡ |
|----------|------|
| ğŸ”´ é”™è¯¯ | 2 |
| ğŸŸ¡ è­¦å‘Š | 2 |
| ğŸ”µ ä¿¡æ¯ | 1 |

## è¯¦ç»†é—®é¢˜

### ğŸ”´ ç¼ºå¤±æ¼‚ç§»

1. **FR-003** æœªå®ç°
   - ä½ç½®: specs/user-auth.fspec.md:25
   - å»ºè®®: æ·»åŠ  FR-003 å¯¹åº”çš„å®ç°

### ğŸŸ¡ æ–°å¢æ¼‚ç§»

1. **changeEmail** å‡½æ•°æœªåœ¨è§„æ ¼ä¸­å®šä¹‰
   - ä½ç½®: src/user-auth/index.js:45
   - å»ºè®®: åœ¨è§„æ ¼ä¸­æ·»åŠ å¯¹åº”éœ€æ±‚æˆ–åˆ é™¤è¯¥å‡½æ•°

### ğŸ”µ ç‰ˆæœ¬æ¼‚ç§»

1. ç‰ˆæœ¬ä¸ä¸€è‡´
   - è§„æ ¼: 2.0.0
   - ä»£ç : 1.0.0
   - å»ºè®®: é‡æ–°æ‰§è¡Œ emit æ›´æ–°æ´¾ç”Ÿäº§ç‰©
```

## ä¿®å¤ç­–ç•¥

### è‡ªåŠ¨ä¿®å¤

| æ¼‚ç§»ç±»å‹ | æ˜¯å¦å¯è‡ªåŠ¨ä¿®å¤ | ä¿®å¤æ–¹å¼ |
|----------|---------------|----------|
| ç‰ˆæœ¬æ¼‚ç§» | âœ… | é‡æ–° emit |
| ç¼ºå¤±æ¼‚ç§» | âš ï¸ éƒ¨åˆ† | ç”Ÿæˆå‡½æ•°éª¨æ¶ |
| æ–°å¢æ¼‚ç§» | âŒ | éœ€äººå·¥åˆ¤æ–­ |
| å˜å¼‚æ¼‚ç§» | âŒ | éœ€äººå·¥åˆ¤æ–­ |

### ä¿®å¤ä¼˜å…ˆçº§

1. **å…ˆä¿®å¤é”™è¯¯çº§åˆ«** - å½±å“åŠŸèƒ½æ­£ç¡®æ€§
2. **å†ä¿®å¤è­¦å‘Šçº§åˆ«** - å¯èƒ½å¯¼è‡´ç»´æŠ¤é—®é¢˜
3. **æœ€åå¤„ç†ä¿¡æ¯çº§åˆ«** - ä¼˜åŒ–å»ºè®®

## æŒç»­å®ˆæŠ¤

### Git Hook é›†æˆ

```bash
# .git/hooks/pre-commit
#!/bin/bash
npx mob-seed defend specs/*.fspec.md --strict
if [ $? -ne 0 ]; then
  echo "âŒ æ£€æµ‹åˆ°æ¼‚ç§»ï¼Œè¯·å…ˆä¿®å¤åå†æäº¤"
  exit 1
fi
```

### CI é›†æˆ

```yaml
# åœ¨ CI ä¸­æ·»åŠ æ¼‚ç§»æ£€æµ‹æ­¥éª¤
- name: SEED Drift Check
  run: npx mob-seed defend specs/*.fspec.md --strict --report
```
