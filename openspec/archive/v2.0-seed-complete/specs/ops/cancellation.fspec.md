# Feature: Task Cancellation (ä»»åŠ¡å–æ¶ˆ)

> çŠ¶æ€: archived
> ç‰ˆæœ¬: 1.0.0
> æŠ€æœ¯æ ˆ: JavaScript
> æ´¾ç”Ÿè·¯å¾„: skills/mob-seed/lib/ops/
> ä¼˜å…ˆçº§: P2
> é¢„è®¡å·¥ä½œé‡: 1-2å¤©

## æ¦‚è¿°

æ”¯æŒå¼€å‘è¿‡ç¨‹ä¸­çš„ä»»åŠ¡å–æ¶ˆå’ŒçŠ¶æ€å›æ»šï¼Œç¡®ä¿å–æ¶ˆæ“ä½œä¸ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´æˆ–ä¸¢å¤±å·²å®Œæˆçš„å·¥ä½œã€‚

## ADDED Requirements

### REQ-001: å–æ¶ˆè§¦å‘æ–¹å¼

The system SHALL support multiple cancellation triggers.

**è§¦å‘æ–¹å¼:**

| æ–¹å¼ | è§¦å‘æ¡ä»¶ | å¤„ç†æ–¹å¼ |
|------|----------|----------|
| ç”¨æˆ·ä¸»åŠ¨ | Ctrl+C æˆ–å‘½ä»¤å–æ¶ˆ | æ­£å¸¸å–æ¶ˆæµç¨‹ |
| è¶…æ—¶ | è¶…è¿‡é…ç½®çš„æ—¶é—´é™åˆ¶ | è¶…æ—¶å–æ¶ˆæµç¨‹ |
| é”™è¯¯ç´¯ç§¯ | è¿ç»­é”™è¯¯è¶…è¿‡é˜ˆå€¼ | è‡ªåŠ¨å–æ¶ˆ |
| å¤–éƒ¨ä¸­æ–­ | ç³»ç»Ÿä¿¡å· (SIGTERM) | ä¼˜é›…å…³é—­ |

**Scenario: ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ**
- WHEN ç”¨æˆ·å‘é€å–æ¶ˆä¿¡å·
- THEN æ ‡è®°å½“å‰ä»»åŠ¡ä¸ºå–æ¶ˆä¸­
- AND æ‰§è¡Œæ¸…ç†æ“ä½œ
- AND ä¿å­˜å½“å‰è¿›åº¦

**Scenario: è¶…æ—¶å–æ¶ˆ**
- WHEN ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡é™åˆ¶
- THEN è‡ªåŠ¨è§¦å‘å–æ¶ˆ
- AND è®°å½•è¶…æ—¶åŸå› 
- AND ä¿å­˜å·²å®Œæˆçš„éƒ¨åˆ†

**Acceptance Criteria:**
- [ ] AC-001: æ”¯æŒ Ctrl+C å–æ¶ˆ
- [ ] AC-002: æ”¯æŒè¶…æ—¶è‡ªåŠ¨å–æ¶ˆ
- [ ] AC-003: æ”¯æŒ API æ–¹å¼å–æ¶ˆ

### REQ-002: å®‰å…¨å–æ¶ˆç‚¹

The system SHALL define safe cancellation points.

**å–æ¶ˆç‚¹å®šä¹‰:**

| é˜¶æ®µ | å–æ¶ˆç‚¹ | å®‰å…¨æ€§ |
|------|--------|--------|
| åˆ†æ | ä»»ä½•æ—¶å€™ | âœ… å®‰å…¨ |
| è®¾è®¡ | ä»»ä½•æ—¶å€™ | âœ… å®‰å…¨ |
| å®ç° | æ–‡ä»¶å†™å…¥å®Œæˆå | âš ï¸ éœ€æ£€æŸ¥ |
| æµ‹è¯• | æµ‹è¯•ç”¨ä¾‹å®Œæˆå | âœ… å®‰å…¨ |
| éªŒè¯ | éªŒè¯å‘½ä»¤å®Œæˆå | âœ… å®‰å…¨ |

**Scenario: åœ¨å®‰å…¨ç‚¹å–æ¶ˆ**
- WHEN æ”¶åˆ°å–æ¶ˆä¿¡å·
- AND å½“å‰ä¸åœ¨å®‰å…¨å–æ¶ˆç‚¹
- THEN ç­‰å¾…åˆ°è¾¾ä¸‹ä¸€ä¸ªå®‰å…¨ç‚¹
- AND ç„¶åæ‰§è¡Œå–æ¶ˆ

**Scenario: å¼ºåˆ¶å–æ¶ˆ**
- WHEN ç­‰å¾…å®‰å…¨ç‚¹è¶…è¿‡ 30 ç§’
- THEN å¼ºåˆ¶å–æ¶ˆ
- AND æ ‡è®°å¯èƒ½ä¸ä¸€è‡´çš„çŠ¶æ€
- AND è®°å½•å¼ºåˆ¶å–æ¶ˆæ—¥å¿—

**Acceptance Criteria:**
- [ ] AC-004: è¯†åˆ«å®‰å…¨å–æ¶ˆç‚¹
- [ ] AC-005: ä¼˜å…ˆåœ¨å®‰å…¨ç‚¹å–æ¶ˆ
- [ ] AC-006: æ”¯æŒå¼ºåˆ¶å–æ¶ˆ

### REQ-003: çŠ¶æ€ä¿å­˜

The system SHALL save state before cancellation.

**ä¿å­˜å†…å®¹:**

| å†…å®¹ | ä¿å­˜ä½ç½® | ç”¨é€” |
|------|----------|------|
| ä»»åŠ¡è¿›åº¦ | tasks.md | æ¢å¤ç»§ç»­ |
| å·¥ä½œæµçŠ¶æ€ | flow-state.json | æµç¨‹æ¢å¤ |
| ä¸´æ—¶æ–‡ä»¶ | .seed/temp/ | æ•°æ®æ¢å¤ |
| æ—¥å¿— | .seed/logs/ | é—®é¢˜åˆ†æ |

**Scenario: ä¿å­˜å–æ¶ˆæ—¶çŠ¶æ€**
- WHEN æ‰§è¡Œå–æ¶ˆæ“ä½œ
- THEN ä¿å­˜å½“å‰ä»»åŠ¡è¿›åº¦åˆ° tasks.md
- AND ä¿å­˜å·¥ä½œæµçŠ¶æ€
- AND ç”Ÿæˆå–æ¶ˆæŠ¥å‘Š

**å–æ¶ˆæŠ¥å‘Šæ ¼å¼:**

```markdown
# ä»»åŠ¡å–æ¶ˆæŠ¥å‘Š

> å–æ¶ˆæ—¶é—´: 2025-01-01 14:30:00
> å–æ¶ˆåŸå› : ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ

## å–æ¶ˆæ—¶çŠ¶æ€

| é¡¹ç›® | çŠ¶æ€ |
|------|------|
| å½“å‰é˜¶æ®µ | å®ç° (3/5) |
| å·²å®Œæˆä»»åŠ¡ | 5/12 |
| å½“å‰ä»»åŠ¡ | TASK-006 (è¿›è¡Œä¸­) |

## å·²å®Œæˆçš„å·¥ä½œ

- âœ… TASK-001: éœ€æ±‚åˆ†æ
- âœ… TASK-002: æ¶æ„è®¾è®¡
- âœ… TASK-003: complexity-router.js
- âœ… TASK-004: flow-router.js
- âœ… TASK-005: task-sync.js
- â¸ï¸ TASK-006: æµ‹è¯•ä»£ç  (å·²ä¿å­˜éƒ¨åˆ†è¿›åº¦)

## æ¢å¤æŒ‡å—

è¦ç»§ç»­æ­¤ä»»åŠ¡ï¼Œè¯·è¿è¡Œ:
```bash
/mob-seed-resume --flow-id=flow-20250101-143000
```
```

**Acceptance Criteria:**
- [ ] AC-007: ä¿å­˜ä»»åŠ¡è¿›åº¦
- [ ] AC-008: ä¿å­˜å·¥ä½œæµçŠ¶æ€
- [ ] AC-009: ç”Ÿæˆå–æ¶ˆæŠ¥å‘Š

### REQ-004: èµ„æºæ¸…ç†

The system SHALL clean up resources on cancellation.

**éœ€è¦æ¸…ç†çš„èµ„æº:**

| èµ„æºç±»å‹ | æ¸…ç†æ–¹å¼ | ä¿ç•™æ¡ä»¶ |
|----------|----------|----------|
| ä¸´æ—¶æ–‡ä»¶ | åˆ é™¤ | æ—  |
| é”æ–‡ä»¶ | é‡Šæ”¾ | æ—  |
| å­è¿›ç¨‹ | ç»ˆæ­¢ | æ—  |
| åŠæˆå“ä»£ç  | å›æ»šæˆ–ä¿ç•™ | å¯é…ç½® |
| æµ‹è¯•ç¯å¢ƒ | é‡ç½® | æ—  |

**Scenario: æ¸…ç†èµ„æº**
- WHEN å–æ¶ˆæ“ä½œè§¦å‘
- THEN ç»ˆæ­¢è¿è¡Œä¸­çš„å­è¿›ç¨‹
- AND é‡Šæ”¾æ‰€æœ‰é”
- AND æ¸…ç†ä¸´æ—¶æ–‡ä»¶
- AND æ ¹æ®é…ç½®å¤„ç†åŠæˆå“ä»£ç 

**Acceptance Criteria:**
- [ ] AC-010: ç»ˆæ­¢å­è¿›ç¨‹
- [ ] AC-011: é‡Šæ”¾é”èµ„æº
- [ ] AC-012: æ¸…ç†ä¸´æ—¶æ–‡ä»¶

### REQ-005: å–æ¶ˆæ¢å¤

The system SHALL support resuming after cancellation.

**Scenario: ä»å–æ¶ˆç‚¹æ¢å¤**
- WHEN ç”¨æˆ·è¯·æ±‚æ¢å¤å·²å–æ¶ˆçš„ä»»åŠ¡
- THEN åŠ è½½ä¿å­˜çš„çŠ¶æ€
- AND ä»ä¸Šæ¬¡å®‰å…¨ç‚¹ç»§ç»­
- AND è·³è¿‡å·²å®Œæˆçš„æ­¥éª¤

**æ¢å¤é€‰é¡¹:**

| é€‰é¡¹ | è¯´æ˜ | å‘½ä»¤ |
|------|------|------|
| ç»§ç»­ | ä»å–æ¶ˆç‚¹ç»§ç»­ | `--resume` |
| é‡æ–°å¼€å§‹ | ä»å¤´å¼€å§‹ï¼Œä¿ç•™é…ç½® | `--restart` |
| ä»é˜¶æ®µå¼€å§‹ | ä»æŒ‡å®šé˜¶æ®µå¼€å§‹ | `--from-stage=design` |

**æ¢å¤äº¤äº’:**

```
ğŸ“‹ æ£€æµ‹åˆ°æœªå®Œæˆçš„ä»»åŠ¡
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æµç¨‹ ID: flow-20250101-143000
å–æ¶ˆæ—¶é—´: 2025-01-01 14:30:00
å–æ¶ˆé˜¶æ®µ: å®ç° (3/5)
å·²å®Œæˆ: 5/12 ä»»åŠ¡

é€‰æ‹©æ“ä½œ:
[C] ç»§ç»­ - ä»å–æ¶ˆç‚¹ç»§ç»­
[R] é‡æ–°å¼€å§‹ - ä¿ç•™é…ç½®ï¼Œé‡æ–°æ‰§è¡Œ
[S] ä»é˜¶æ®µå¼€å§‹ - é€‰æ‹©å¼€å§‹é˜¶æ®µ
[D] æ”¾å¼ƒ - æ¸…ç†çŠ¶æ€ï¼Œä¸æ¢å¤

è¯·é€‰æ‹©: [C/R/S/D]
```

**Acceptance Criteria:**
- [ ] AC-013: æ”¯æŒä»å–æ¶ˆç‚¹ç»§ç»­
- [ ] AC-014: æ”¯æŒé‡æ–°å¼€å§‹
- [ ] AC-015: æ”¯æŒé€‰æ‹©å¼€å§‹é˜¶æ®µ

### REQ-006: å–æ¶ˆæ—¥å¿—

The system SHALL log cancellation events.

**æ—¥å¿—å†…å®¹:**

| å­—æ®µ | è¯´æ˜ |
|------|------|
| æ—¶é—´ | å–æ¶ˆå‘ç”Ÿæ—¶é—´ |
| åŸå›  | å–æ¶ˆåŸå›  |
| è§¦å‘æ–¹å¼ | ç”¨æˆ·/è¶…æ—¶/é”™è¯¯ |
| å½“å‰çŠ¶æ€ | å–æ¶ˆæ—¶çš„ä»»åŠ¡çŠ¶æ€ |
| æ¸…ç†ç»“æœ | èµ„æºæ¸…ç†æƒ…å†µ |
| æ¢å¤ä¿¡æ¯ | å¦‚ä½•æ¢å¤ |

**Scenario: è®°å½•å–æ¶ˆæ—¥å¿—**
- WHEN å–æ¶ˆæ“ä½œå®Œæˆ
- THEN è®°å½•å®Œæ•´çš„å–æ¶ˆæ—¥å¿—
- AND è¿½åŠ åˆ° `.seed/cancellation.log`

**Acceptance Criteria:**
- [ ] AC-016: è®°å½•å®Œæ•´å–æ¶ˆä¿¡æ¯
- [ ] AC-017: æ—¥å¿—å¯æŸ¥è¯¢
- [ ] AC-018: æ”¯æŒæ—¥å¿—è½®è½¬

## å¯¼å‡ºæ¥å£

```javascript
module.exports = {
  // å–æ¶ˆè§¦å‘
  requestCancel,            // (flowId, reason) => void
  registerCancelHandler,    // (handler) => void

  // å®‰å…¨ç‚¹
  markSafePoint,            // (flowId) => void
  isAtSafePoint,            // (flowId) => boolean
  waitForSafePoint,         // (flowId, timeout) => Promise<boolean>

  // çŠ¶æ€ä¿å­˜
  saveState,                // (flowId) => StateSnapshot
  generateCancelReport,     // (flowId, snapshot) => string

  // èµ„æºæ¸…ç†
  cleanup,                  // (flowId) => CleanupResult
  terminateSubprocesses,    // (flowId) => void
  releaseLocks,             // (flowId) => void

  // æ¢å¤
  canResume,                // (flowId) => boolean
  resume,                   // (flowId, options) => void
  getResumeOptions,         // (flowId) => ResumeOption[]

  // æ—¥å¿—
  logCancellation,          // (cancelEvent) => void
  getCancellationHistory,   // (flowId?) => CancelEvent[]
};
```

## é…ç½®é¡¹

```json
{
  "cancellation": {
    "safePointTimeout": 30,
    "keepPartialWork": true,
    "autoCleanTemp": true,
    "logFile": ".seed/cancellation.log",
    "maxLogSize": "10MB",
    "gracefulShutdownTimeout": 5
  }
}
```

## ä¾èµ–

- `core/task-sync.js` - ä»»åŠ¡çŠ¶æ€
- `workflow/flow-router.js` - å·¥ä½œæµçŠ¶æ€

## æµ‹è¯•è¦ç‚¹

1. å„ç§å–æ¶ˆè§¦å‘æ–¹å¼
2. å®‰å…¨ç‚¹æ£€æµ‹å‡†ç¡®æ€§
3. çŠ¶æ€ä¿å­˜å®Œæ•´æ€§
4. èµ„æºæ¸…ç†å½»åº•æ€§
5. æ¢å¤åŠŸèƒ½æ­£ç¡®æ€§
