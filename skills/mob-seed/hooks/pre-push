#!/bin/bash
# ============================================================================
# SEED Pre-Push Hook
# å¢é‡æ£€æŸ¥ï¼šæ£€æŸ¥æ‰€æœ‰æœªæ¨é€çš„ commits
# ============================================================================

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# è¿è¡Œæ¨¡å¼æ ‡è¯†
SEED_MODE=""
SEED_MODE_LABEL=""

# æ£€æŸ¥æ˜¯å¦åœ¨ SEED é¡¹ç›®ä¸­
if [ ! -f ".seed/config.json" ]; then
    exit 0
fi

# å››å±‚å›é€€æ¨¡å¼æŸ¥æ‰¾è„šæœ¬ï¼ˆåŒæ—¶æ£€æµ‹è¿è¡Œåœºæ™¯ï¼‰
# Layer 0: ç¯å¢ƒå˜é‡æŒ‡å®šçš„æ’ä»¶è·¯å¾„ï¼ˆç”¨æˆ·é¡¹ç›®ï¼Œæ˜¾å¼é…ç½®ï¼‰
# Layer 1: åº“è·¯å¾„ï¼ˆmob-seed é¡¹ç›®å†… dogfoodingï¼‰
# Layer 2: .seed/scriptsï¼ˆç¬¦å·é“¾æ¥æˆ–å¤åˆ¶ï¼‰
# Layer 3: Claude Code æ’ä»¶é»˜è®¤è·¯å¾„ï¼ˆç”¨æˆ·é¡¹ç›®ï¼Œé»˜è®¤è·¯å¾„ï¼‰
find_hook_script() {
    local script_name="$1"

    # Layer 0: ç¯å¢ƒå˜é‡æŒ‡å®šçš„è·¯å¾„ï¼ˆinit æ—¶è®¾ç½®ï¼‰- ç”¨æˆ·é¡¹ç›®
    if [ -n "$SEED_PLUGIN_PATH" ] && [ -f "${SEED_PLUGIN_PATH}/lib/hooks/${script_name}.js" ]; then
        SEED_MODE="user-env"
        SEED_MODE_LABEL="${MAGENTA}[ç”¨æˆ·é¡¹ç›®]${NC} ç¯å¢ƒå˜é‡é…ç½®"
        echo "${SEED_PLUGIN_PATH}/lib/hooks/${script_name}.js"
        return 0
    fi

    # Layer 1: åº“è·¯å¾„ï¼ˆmob-seed é¡¹ç›®å†… dogfoodingï¼‰- å¼€å‘æ¨¡å¼
    if [ -f "skills/mob-seed/lib/hooks/${script_name}.js" ]; then
        SEED_MODE="dogfooding"
        SEED_MODE_LABEL="${CYAN}[å¼€å‘æ¨¡å¼]${NC} mob-seed dogfooding"
        echo "skills/mob-seed/lib/hooks/${script_name}.js"
        return 0
    fi

    # Layer 2: .seed/scriptsï¼ˆç¬¦å·é“¾æ¥æˆ–å¤åˆ¶ï¼‰- å…¼å®¹æ¨¡å¼
    if [ -f ".seed/scripts/${script_name}.js" ]; then
        SEED_MODE="compat"
        SEED_MODE_LABEL="${YELLOW}[å…¼å®¹æ¨¡å¼]${NC} .seed/scripts"
        echo ".seed/scripts/${script_name}.js"
        return 0
    fi

    # Layer 3: Claude Code ç”¨æˆ·æ’ä»¶è·¯å¾„ï¼ˆå¸¸è§ä½ç½®ï¼‰- ç”¨æˆ·é¡¹ç›®
    local cc_plugin_path="$HOME/.claude/plugins/mobfish-ai/mob-seed/skills/mob-seed"
    if [ -f "${cc_plugin_path}/lib/hooks/${script_name}.js" ]; then
        SEED_MODE="user-plugin"
        SEED_MODE_LABEL="${MAGENTA}[ç”¨æˆ·é¡¹ç›®]${NC} Claude Code æ’ä»¶"
        echo "${cc_plugin_path}/lib/hooks/${script_name}.js"
        return 0
    fi

    # æœªæ‰¾åˆ°è„šæœ¬ - é”™è¯¯æ¨¡å¼
    SEED_MODE="missing"
    SEED_MODE_LABEL="${RED}[é”™è¯¯]${NC} æœªæ‰¾åˆ°éªŒè¯è„šæœ¬"
    return 1
}

# è·å–ç‰ˆæœ¬å·
get_version() {
    # å°è¯•ä» package.json è¯»å–ç‰ˆæœ¬å·
    local version="unknown"
    local pkg_json=""

    # Layer 1: dogfooding
    if [ -f "skills/mob-seed/package.json" ]; then
        pkg_json="skills/mob-seed/package.json"
    # Layer 2: ç¯å¢ƒå˜é‡
    elif [ -n "$SEED_PLUGIN_PATH" ] && [ -f "${SEED_PLUGIN_PATH}/package.json" ]; then
        pkg_json="${SEED_PLUGIN_PATH}/package.json"
    # Layer 3: Claude Code æ’ä»¶
    elif [ -f "$HOME/.claude/plugins/mobfish-ai/mob-seed/skills/mob-seed/package.json" ]; then
        pkg_json="$HOME/.claude/plugins/mobfish-ai/mob-seed/skills/mob-seed/package.json"
    fi

    if [ -n "$pkg_json" ]; then
        version=$(node -e "console.log(require('${pkg_json}').version)" 2>/dev/null || echo "unknown")
    fi

    echo "$version"
}

# è¯»å–æ¨é€å‚æ•°
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # åˆ é™¤åˆ†æ”¯ï¼Œè·³è¿‡
        continue
    fi

    # å…ˆå°è¯•æ‰¾è„šæœ¬ä»¥ç¡®å®šæ¨¡å¼ï¼ˆä¸æ•è·è¾“å‡ºï¼Œè®©å˜é‡åœ¨çˆ¶ shell ä¸­è®¾ç½®ï¼‰
    find_hook_script "incremental-defender" > /dev/null 2>&1 || \
        find_hook_script "incremental-defend" > /dev/null 2>&1 || true

    # è·å–ç‰ˆæœ¬å·
    SEED_VERSION=$(get_version)

    echo -e "${BLUE}ğŸ” SEED å¢é‡æ£€æŸ¥...${NC} v${SEED_VERSION} ${SEED_MODE_LABEL}"

    # è·å–è„šæœ¬è·¯å¾„ï¼ˆç°åœ¨ SEED_MODE å·²è®¾ç½®ï¼Œå¯ä»¥å®‰å…¨æ•è·ï¼‰
    INCREMENTAL_DEFENDER=$(find_hook_script "incremental-defender" 2>/dev/null || find_hook_script "incremental-defend" 2>/dev/null || echo "")

    # è·å–æœªæ¨é€çš„ commits æ¶‰åŠçš„æ–‡ä»¶
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # æ–°åˆ†æ”¯ï¼Œæ£€æŸ¥ä¸ main çš„å·®å¼‚
        UNPUSHED_FILES=$(git diff --name-only origin/main...HEAD 2>/dev/null || git diff --name-only HEAD~10...HEAD 2>/dev/null || echo "")
    else
        UNPUSHED_FILES=$(git diff --name-only "$remote_sha"..."$local_sha" 2>/dev/null || echo "")
    fi

    if [ -z "$UNPUSHED_FILES" ]; then
        echo -e "${GREEN}âœ… æ— æ–‡ä»¶å˜æ›´${NC}"
        continue
    fi

    # è¿‡æ»¤è§„æ ¼ç›¸å…³æ–‡ä»¶
    SPEC_FILES=$(echo "$UNPUSHED_FILES" | grep -E '\.(fspec\.md|js|ts)$' || echo "")

    if [ -z "$SPEC_FILES" ]; then
        echo -e "${GREEN}âœ… æ— è§„æ ¼ç›¸å…³æ–‡ä»¶å˜æ›´${NC}"
        continue
    fi

    echo -e "${YELLOW}æ£€æŸ¥æ–‡ä»¶: $(echo "$SPEC_FILES" | wc -l | tr -d ' ') ä¸ª${NC}"

    # å¢é‡æ£€æŸ¥ï¼ˆINCREMENTAL_DEFENDER å·²åœ¨ä¸Šé¢è·å–ï¼‰
    if [ -n "$INCREMENTAL_DEFENDER" ]; then
        if ! node "$INCREMENTAL_DEFENDER" --files="$SPEC_FILES"; then
            echo -e "${RED}âŒ SEED æ£€æŸ¥å¤±è´¥ï¼Œæ¨é€è¢«é˜»æ­¢${NC}"
            echo -e "${YELLOW}è¯·ä¿®å¤é—®é¢˜åé‡æ–°æ¨é€${NC}"
            exit 1
        fi
    elif [ "$SEED_MODE" = "missing" ]; then
        echo -e "${YELLOW}âš ï¸  æœªæ‰¾åˆ°å¢é‡æ£€æŸ¥è„šæœ¬ï¼Œè·³è¿‡éªŒè¯${NC}"
        echo -e "${YELLOW}   è¯·ç¡®è®¤ mob-seed æ’ä»¶å·²æ­£ç¡®å®‰è£…${NC}"
    fi

    # æ›´æ–°ç¼“å­˜
    CACHE_UPDATER=$(find_hook_script "cache-updater" || find_hook_script "update-cache" || echo "")
    if [ -n "$CACHE_UPDATER" ]; then
        node "$CACHE_UPDATER" --files="$SPEC_FILES" 2>/dev/null || true
    fi

    echo -e "${GREEN}âœ… SEED å¢é‡æ£€æŸ¥é€šè¿‡${NC}"
done

exit 0
