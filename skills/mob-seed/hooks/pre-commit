#!/bin/bash
# ============================================================================
# SEED Pre-Commit Hook
# 快速检查：仅检查 staged 文件
# ============================================================================

set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# 运行模式标识
SEED_MODE=""
SEED_MODE_LABEL=""

# 跳过检查（紧急情况）
if [ "$SKIP_SEED_CHECK" = "1" ]; then
    echo -e "${YELLOW}⚠️  SEED 检查已跳过${NC}"
    exit 0
fi

# 检查是否在 SEED 项目中
if [ ! -f ".seed/config.json" ]; then
    # 不是 SEED 项目，静默退出
    exit 0
fi

# 获取 staged 文件
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || echo "")

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# 过滤规格相关文件
SPEC_FILES=$(echo "$STAGED_FILES" | grep -E '\.(fspec\.md|js|ts)$' || echo "")

if [ -z "$SPEC_FILES" ]; then
    exit 0
fi

# 四层回退模式查找脚本（同时检测运行场景）
# Layer 0: 环境变量指定的插件路径（用户项目，显式配置）
# Layer 1: 库路径（mob-seed 项目内 dogfooding）
# Layer 2: .seed/scripts（符号链接或复制）
# Layer 3: Claude Code 插件默认路径（用户项目，默认路径）
find_hook_script() {
    local script_name="$1"

    # Layer 0: 环境变量指定的路径（init 时设置）- 用户项目
    if [ -n "$SEED_PLUGIN_PATH" ] && [ -f "${SEED_PLUGIN_PATH}/lib/hooks/${script_name}.js" ]; then
        SEED_MODE="user-env"
        SEED_MODE_LABEL="${MAGENTA}[用户项目]${NC} 环境变量配置"
        echo "${SEED_PLUGIN_PATH}/lib/hooks/${script_name}.js"
        return 0
    fi

    # Layer 1: 库路径（mob-seed 项目内 dogfooding）- 开发模式
    if [ -f "skills/mob-seed/lib/hooks/${script_name}.js" ]; then
        SEED_MODE="dogfooding"
        SEED_MODE_LABEL="${CYAN}[开发模式]${NC} mob-seed dogfooding"
        echo "skills/mob-seed/lib/hooks/${script_name}.js"
        return 0
    fi

    # Layer 2: .seed/scripts（符号链接或复制）- 兼容模式
    if [ -f ".seed/scripts/${script_name}.js" ]; then
        SEED_MODE="compat"
        SEED_MODE_LABEL="${YELLOW}[兼容模式]${NC} .seed/scripts"
        echo ".seed/scripts/${script_name}.js"
        return 0
    fi

    # Layer 3: Claude Code 用户插件路径（常见位置）- 用户项目
    local cc_plugin_path="$HOME/.claude/plugins/mobfish-ai/mob-seed/skills/mob-seed"
    if [ -f "${cc_plugin_path}/lib/hooks/${script_name}.js" ]; then
        SEED_MODE="user-plugin"
        SEED_MODE_LABEL="${MAGENTA}[用户项目]${NC} Claude Code 插件"
        echo "${cc_plugin_path}/lib/hooks/${script_name}.js"
        return 0
    fi

    return 1
}

# 先尝试找脚本以确定模式（不捕获输出，让变量在父 shell 中设置）
find_hook_script "quick-defender" > /dev/null 2>&1 || \
    find_hook_script "quick-defend" > /dev/null 2>&1 || true

# 显示带场景标识的提示
echo -e "${BLUE}🔍 SEED 快速检查...${NC} ${SEED_MODE_LABEL}"

# 获取脚本路径（现在 SEED_MODE 已设置，可以安全捕获）
QUICK_DEFENDER=$(find_hook_script "quick-defender" 2>/dev/null || find_hook_script "quick-defend" 2>/dev/null || echo "")

# 检查缓存
CACHE_CHECKER=$(find_hook_script "cache-checker" 2>/dev/null || find_hook_script "check-cache" 2>/dev/null || echo "")
if [ -n "$CACHE_CHECKER" ]; then
    if node "$CACHE_CHECKER" --files="$SPEC_FILES" 2>/dev/null; then
        echo -e "${GREEN}✅ 使用缓存结果（文件未变更）${NC}"
        exit 0
    fi
fi

# 快速同步检查（QUICK_DEFENDER 已在上面获取）
if [ -n "$QUICK_DEFENDER" ]; then
    if ! node "$QUICK_DEFENDER" --files="$SPEC_FILES"; then
        echo -e "${RED}❌ SEED 检查失败${NC}"
        echo -e "${YELLOW}提示: 使用 SKIP_SEED_CHECK=1 git commit 跳过（不推荐）${NC}"
        exit 1
    fi
fi

echo -e "${GREEN}✅ SEED 快速检查通过${NC}"
exit 0
