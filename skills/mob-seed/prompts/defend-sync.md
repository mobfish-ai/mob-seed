# 同步检查指导

> SEED D阶段 - 规格与代码同步检查

## 核心原则

1. **规格为准**: 规格是唯一真相源，代码必须与规格一致
2. **双向检查**: 既检查代码是否实现规格，也检查代码是否超出规格
3. **可追溯**: 每个检查项都能定位到具体位置
4. **增量检查**: 支持只检查变更部分

## 检查流程

```
┌─────────────────────────────────────────────────────────────┐
│                   同步检查流程                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. 加载规格                                                 │
│     ├── 解析 .fspec.md                                      │
│     ├── 提取需求列表 (FR-xxx)                               │
│     └── 提取验收标准 (AC-xxx)                               │
│                                                              │
│  2. 加载派生清单                                             │
│     ├── 读取 seed-manifest.json                             │
│     └── 定位派生文件路径                                    │
│                                                              │
│  3. 需求覆盖检查                                             │
│     ├── 遍历每个 FR                                         │
│     ├── 在代码中搜索 @see FR-xxx                            │
│     └── 检查函数是否存在且非空                              │
│                                                              │
│  4. 测试覆盖检查                                             │
│     ├── 遍历每个 AC                                         │
│     ├── 在测试中搜索 AC-xxx                                 │
│     └── 检查测试用例是否存在                                │
│                                                              │
│  5. 文档同步检查                                             │
│     ├── 比较版本号                                          │
│     ├── 比较功能列表                                        │
│     └── 检查生成时间                                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## 检查规则

### 需求覆盖 (FR → Code)

```javascript
// 规则: 每个 FR 必须有对应的实现

// 检查方式:
// 1. 在代码中搜索 @see FR-xxx 注释
// 2. 验证对应的函数/类存在
// 3. 验证函数体不为空（不是 TODO）

// 通过条件:
// - 找到 @see FR-xxx 注释 ✅
// - 对应函数存在 ✅
// - 函数有实际实现（非 TODO）✅

// 示例:
/**
 * 用户登录
 * @see FR-001  ← 关联到规格
 */
async function login(email, password) {
  // 实际实现，非 TODO
  const user = await findUser(email);
  // ...
}
```

### 测试覆盖 (AC → Test)

```javascript
// 规则: 每个 AC 必须有对应的测试

// 检查方式:
// 1. 在测试文件中搜索 AC-xxx
// 2. 验证 describe/it 块存在
// 3. 验证 Given-When-Then 注释存在

// 通过条件:
// - 找到 AC-xxx 引用 ✅
// - 对应测试用例存在 ✅
// - 包含 Given-When-Then 结构 ✅

// 示例:
describe('AC-001: 登录成功', () => {
  it('should redirect to home page', async () => {
    // Given: 用户已注册
    // When: 点击登录
    // Then: 跳转到首页
    // ... 断言
  });
});
```

### 文档同步 (Spec → Docs)

```markdown
检查项:
1. 版本号一致性
   - 规格: version: 1.0.0
   - 文档: 版本: 1.0.0

2. 功能列表完整性
   - 规格中的所有 FR 都在文档中有说明

3. 生成时间合理性
   - 文档生成时间不早于规格修改时间
```

## 检查结果格式

### 单项检查结果

```json
{
  "rule": "FR_COVERAGE",
  "target": "FR-001",
  "status": "passed" | "failed" | "warning",
  "location": {
    "spec": "specs/user-auth.fspec.md:15",
    "code": "src/user-auth/index.js:23"
  },
  "message": "FR-001 已实现",
  "details": null
}
```

### 汇总结果

```json
{
  "spec": "user-auth",
  "checkedAt": "2024-12-28T10:35:00+08:00",
  "summary": {
    "total": 15,
    "passed": 12,
    "failed": 2,
    "warnings": 1
  },
  "coverage": {
    "fr": { "total": 5, "covered": 4 },
    "ac": { "total": 5, "covered": 5 },
    "docs": { "synced": false }
  },
  "issues": [
    { "rule": "FR_COVERAGE", "target": "FR-003", "status": "failed", ... }
  ]
}
```

## 错误级别

| 级别 | 规则 | 说明 |
|------|------|------|
| ERROR | FR 未实现 | 需求定义但无对应代码 |
| ERROR | AC 无测试 | 验收标准无对应测试 |
| WARNING | 文档过时 | 文档版本低于规格版本 |
| WARNING | TODO 实现 | 函数体只有 TODO |
| INFO | 额外实现 | 代码中有规格未定义的功能 |

## 自动修复

### 可修复项

| 问题 | 修复方式 |
|------|----------|
| 文档版本过时 | 重新执行 `emit --docs` |
| 测试骨架缺失 | 生成空测试用例模板 |

### 不可修复项

| 问题 | 说明 |
|------|------|
| FR 未实现 | 需要人工编写业务逻辑 |
| 逻辑不一致 | 需要人工判断和修改 |
